<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Draft</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <link rel="icon" href="/favicon.ico">
    <link rel="icon" type="image/png" href="/moscow-m1x-draft/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/moscow-m1x-draft/favicon.svg" />
    <link rel="shortcut icon" href="/moscow-m1x-draft/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/moscow-m1x-draft/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Moscow-m1x-draft" />
    <link rel="manifest" href="/moscow-m1x-draft/site.webmanifest" />
    <link rel="stylesheet" href="styles.css">
    <style id="pageStyle">
        .content-wrapper {
            padding: 60px 20px 100px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
        }
        h1 {
            text-align: center;
            margin: 0 0 30px;
            font-size: 3.6em;
            letter-spacing: 4px;
            font-weight: 400;
            text-shadow:
                0 0 6px rgba(255,255,255,0.6),
                0 0 12px rgba(255,255,255,0.3);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 8px;
        }
        .title-main { color: #ffffff; }
        .title-red {
            color: #ff0033;
            text-shadow:
                0 0 6px rgba(255,0,51,0.6),
                0 0 12px rgba(255,0,51,0.3);
        }
        .captain-glow {
            color: #ffffff;
            text-shadow: 0 0 4px rgba(0,0,0,0.8);
            font-weight: 400;
            font-size: 1.15em;
            cursor: pointer;
            display: inline-block;
            padding: 10px 14px;
            border-radius: 8px;
            transition: all 0.25s;
            user-select: none;
            background: rgba(30,30,45,0.85);
            border: 1px solid rgba(100,100,120,0.5);
            letter-spacing: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .captain-glow:hover {
            background: rgba(50,50,70,0.9);
            transform: scale(1.05);
        }
        .captain-glow.active {
            background: rgba(255, 10, 60, 0.85) !important;
            border: 2px solid rgba(255,255,255,0.6);
            color: #fff;
            text-shadow: 0 0 8px #fff, 0 0 16px #ff0033;
            animation: pulse 1.5s infinite;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255,0,51,0.8);
            letter-spacing: 1.5px;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255,0,51,0.4); }
            70% { box-shadow: 0 0 0 12px rgba(255,0,51,0); }
            100% { box-shadow: 0 0 0 0 rgba(255,0,51,0); }
        }
        .turn {
            text-align: center;
            font-size: 1.3em;
            margin: 20px 0;
            padding: 14px;
            background: rgba(30,20,30,0.7);
            border-radius: 12px;
            border: 2px solid rgba(255,0,51,0.5);
            backdrop-filter: blur(8px);
            color: #fff;
            font-weight: 400;
            letter-spacing: 1.2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 20px 0;
        }
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        .team {
            background: rgba(15,15,25,0.8);
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            min-height: 180px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255,50,100,0.3);
            position: relative;
        }
        .team h3 {
            margin: 0 0 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid #ff3366;
            font-size: 1.2em;
            text-align: center;
            font-weight: 400;
            letter-spacing: 1px;
            position: relative;
        }
        .team-name {
            text-align: center;
            font-size: 1.2em;
            color: #ffffff;
            margin: 4px 0 12px;
            font-weight: 600;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            letter-spacing: 1.2px;
            text-shadow: 0 0 6px rgba(255,255,255,0.5);
        }
        .team-name.show {
            opacity: 1;
            transform: translateY(0);
        }
        .final-captain {
            background: rgba(255, 100, 100, 0.3) !important;
            font-weight: bold;
            font-size: 1.05em;
            letter-spacing: 1px;
            border: 1px solid rgba(255,100,100,0.5);
            cursor: default !important;
            pointer-events: none !important;
            opacity: 1 !important;
            transform: none !important;
        }
        .team-players {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
            font-size: 0.95em;
            letter-spacing: 0.5px;
        }
        .team-players::-webkit-scrollbar {
            width: 6px;
        }
        .team-players::-webkit-scrollbar-thumb {
            background: rgba(255,50,100,0.5);
            border-radius: 3px;
        }
        .players {
            background: rgba(15,15,25,0.8);
            padding: 22px 18px 18px;
            border-radius: 14px;
            margin: 25px 0;
            max-height: 420px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .players h3 {
            margin: 0 0 20px;
            color: #ffffff;
            text-align: center;
            font-size: 1.5em;
            font-weight: 400;
            padding-bottom: 8px;
            border-bottom: 1px solid #555;
            letter-spacing: 1.5px;
        }
        .players-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        @media (max-width: 768px) {
            .players-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (max-width: 480px) {
            .players-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .player {
            padding: 10px 8px;
            margin: 0;
            background: rgba(255,255,255,0.08);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 0.95em;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 400;
            letter-spacing: 0.8px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player:hover {
            background: rgba(255,100,100,0.3);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.18);
        }
        .player.selected {
            background: rgba(255, 255, 255, 0.25);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.4);
            cursor: default;
            transform: none;
            box-shadow: inset 0 0 8px rgba(255,255,255,0.3);
            letter-spacing: 0.8px;
        }
        .right-control-panel {
            position: fixed;
            bottom: 16px;
            right: 16px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        .control-btn {
            width: 50px;
            height: 50px;
            background: rgba(30,30,40,0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #e0e0e0;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            transition: all 0.25s;
            border: 1px solid rgba(100,100,120,0.4);
        }
        .control-btn:hover {
            background: rgba(60,60,80,0.9);
            transform: translateY(-3px);
            color: #fff;
        }
        .control-btn.undo-btn {
            background: rgba(40,40,60,0.9);
            color: #ffcc00;
        }
        .control-btn.undo-btn:hover {
            background: rgba(60,60,80,0.9);
            color: #ffdd55;
        }
        .control-btn.reset-btn {
            background: rgba(80, 40, 60, 0.9);
            color: #ff6666;
        }
        .control-btn.reset-btn:hover {
            background: rgba(100, 50, 70, 0.9);
            color: #ff8888;
        }
        .control-btn.config-btn {
            background: rgba(60, 40, 80, 0.9);
            color: #66ccff;
        }
        .control-btn.config-btn:hover {
            background: rgba(80, 50, 100, 0.9);
            color: #88ddff;
        }
        .footer-credit {
            text-align: center;
            margin-top: 70px;
            padding: 10px 0;
            font-size: 0.85em;
            color: #777;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #ffcc00;
            font-weight: bold;
        }
        .firebase-error {
            text-align: center;
            padding: 20px;
            background: rgba(80, 20, 20, 0.9);
            color: #ff6666;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
            border: 1px solid #ff3333;
        }
        .modal-overlay-config {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(8px);
            padding: 20px;
        }
        .modal-content-config {
            background: rgba(20, 20, 35, 0.97);
            padding: 32px;
            border-radius: 20px;
            width: 90%;
            max-width: 650px;
            border: 2px solid rgba(255, 50, 100, 0.6);
            box-shadow: 0 0 40px rgba(255, 0, 51, 0.4);
            text-align: center;
            font-family: 'Bebas Neue', sans-serif;
            color: #ffffff;
            animation: modalFadeIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative;
            overflow: hidden;
        }
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .modal-content-config h3 {
            margin: 0 0 25px;
            font-size: 2.0em;
            color: #fff;
            letter-spacing: 2px;
            text-shadow: 0 0 8px rgba(255, 0, 51, 0.6);
            border-bottom: 2px solid rgba(255, 50, 100, 0.5);
            padding-bottom: 15px;
        }
        .modal-tabs {
            display: flex;
            gap: 8px;
            margin: 0 0 25px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .tab-btn-config {
            padding: 12px 24px;
            background: rgba(30, 30, 45, 0.85);
            border: 1px solid rgba(100, 100, 120, 0.5);
            border-radius: 50px;
            color: #e0e0e0;
            font-size: 1.05em;
            font-weight: 400;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            white-space: nowrap;
            min-width: 120px;
        }
        .tab-btn-config:hover {
            background: rgba(50, 50, 70, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 0, 51, 0.2);
        }
        .tab-btn-config.active {
            background: rgba(255, 10, 60, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.6);
            color: #fff;
            text-shadow: 0 0 6px #fff, 0 0 12px #ff0033;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 0, 51, 0.6);
            animation: pulse 1.5s infinite;
        }
        .config-tab-config {
            display: none;
            margin-bottom: 20px;
        }
        .config-tab-config.active {
            display: block;
            animation: tabSlideIn 0.5s ease-out;
        }
        @keyframes tabSlideIn {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .modal-label {
            display: block;
            text-align: left;
            font-size: 1.1em;
            margin: 0 0 10px;
            color: #ffcc00;
            letter-spacing: 1px;
            font-weight: 400;
            text-shadow: 0 0 4px rgba(255, 204, 0, 0.4);
        }
        .modal-textarea-config {
            width: 100%;
            padding: 16px;
            margin: 0 0 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #fff;
            font-size: 1.05em;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.8px;
            outline: none;
            resize: vertical;
            min-height: 120px;
            transition: all 0.3s;
        }
        .modal-textarea-config:focus {
            border-color: #ff3366;
            box-shadow: 0 0 12px rgba(255, 51, 102, 0.6);
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-1px);
        }
        .modal-error-config {
            color: #ff6666;
            font-size: 1.1em;
            margin: 10px 0 20px;
            min-height: 1.5em;
            font-weight: bold;
            letter-spacing: 0.5px;
            text-shadow: 0 0 4px rgba(255, 102, 102, 0.5);
        }
        .modal-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .modal-btn-config {
            padding: 14px 28px;
            border: none;
            border-radius: 50px;
            color: #fff;
            font-size: 1.15em;
            font-weight: 400;
            letter-spacing: 1.2px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-width: 160px;
        }
        .modal-btn-config.save-btn {
            background: rgba(255, 10, 60, 0.9);
            box-shadow: 0 4px 15px rgba(255, 0, 51, 0.4);
        }
        .modal-btn-config.save-btn:hover {
            background: rgba(255, 30, 80, 0.95);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 0, 51, 0.6);
        }
        .modal-btn-config.cancel-btn {
            background: rgba(60, 60, 80, 0.9);
            box-shadow: 0 4px 15px rgba(100, 100, 120, 0.3);
        }
        .modal-btn-config.cancel-btn:hover {
            background: rgba(80, 80, 100, 0.95);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(100, 100, 120, 0.5);
        }
        @media (max-width: 768px) {
            .content-wrapper {
                padding: 50px 16px 80px;
            }
            h1 {
                font-size: 2.6em;
                letter-spacing: 2px;
                margin: 16px 0 24px;
            }
            .turn {
                font-size: 1.2em;
                padding: 12px;
                margin: 16px 0;
            }
            .team {
                min-height: 160px;
                padding: 10px;
            }
            .player {
                padding: 12px 6px;
                font-size: 0.9em;
            }
            .right-control-panel {
                bottom: 12px;
                gap: 8px;
            }
            .control-btn {
                width: 48px;
                height: 48px;
            }
            .footer-credit {
                margin-top: 90px;
                font-size: 0.8em;
            }
        }
        @media (max-width: 480px) {
            .content-wrapper {
                padding: 40px 12px 70px;
            }
            h1 {
                font-size: 2.2em;
                letter-spacing: 1.5px;
            }
            .turn {
                font-size: 1.1em;
                padding: 10px;
            }
            .player {
                padding: 14px 4px;
                font-size: 0.85em;
            }
            .team-name {
                font-size: 1.1em;
            }
            .control-btn {
                width: 46px;
                height: 46px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo-container">
            <img src="logo.png" alt="Moscow M1X Logo">
        </div>
        <ul class="nav-links">
            <li><a href="index.html">HOME</a></li>
            <li><a href="draft.html" class="active">DRAFT</a></li>
            <li><a href="group-stage.html">GROUP STAGE</a></li>
            <li><a href="bracket.html">PLAYOFF</a></li>
            <li><a href="results.html">RESULTS</a></li>
        </ul>
        <div class="auth-link" id="authHeaderLink">SIGN IN</div>
    </nav>
    <div class="content-wrapper">
        <h1>MOSCOW M<span class="title-red">1</span>X</h1>
        <div class="turn" id="turnIndicator">
            Captain: <span class="captain-glow active" id="currentCaptainIndicator">Loading...</span>
        </div>
        <div class="container" id="teamsContainer">
            <div class="loading" id="loadingIndicator">Loading draft state from cloud...</div>
        </div>
        <div class="players">
            <h3>Players:</h3>
            <div class="players-grid" id="availablePlayers"></div>
        </div>
        <div class="footer-credit">
        </div>
    </div>
    <div class="right-control-panel" id="rightControlPanel">
        <div class="control-btn undo-btn" id="undoBtn" title="–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–±–æ—Ä">‚Ü©Ô∏è</div>
        <div class="control-btn reset-btn" id="resetBtn" title="–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ">üîÑ</div>
        <div class="control-btn config-btn" id="configBtn" title="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–∞–ø–∏—Ç–∞–Ω–æ–≤, –∫–æ–º–∞–Ω–¥—ã –∏ –∏–≥—Ä–æ–∫–æ–≤">‚öôÔ∏è</div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBWnLO_5YgaNFiy-wvynVEKcMnS8V55FXY",
            authDomain: "moscow-m1x-draft-f9da4.firebaseapp.com",
            databaseURL: "https://moscow-m1x-draft-f9da4-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "moscow-m1x-draft-f9da4",
            storageBucket: "moscow-m1x-draft-f9da4.firebasestorage.app",
            messagingSenderId: "391636730262",
            appId: "1:391636730262:web:2441abb086b5336b451db7"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const draftRef = database.ref('moscowM1X/draft');
        const adminsRef = database.ref('moscowM1X/admins');
        const configRef = database.ref('moscowM1X/config');
        const groupStageRef = database.ref('moscowM1X/groupStage');
        const playoffRef = database.ref('moscowM1X/playoffBracket');
        const clientId = 'client-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        let CAPTAINS = [];
        let TEAM_NAMES = {};
        let PLAYERS_LIST = [];
        let activeCaptainIndex = null;
        let teams = [];
        let availablePlayers = [];
        let history = [];
        let draftComplete = false;
        let isAuthenticated = false;
        let isAdmin = false;
        const teamsContainer = document.getElementById('teamsContainer');
        const availableEl = document.getElementById('availablePlayers');
        const currentCaptainIndicator = document.getElementById('currentCaptainIndicator');
        const turnIndicator = document.getElementById('turnIndicator');
        const resetBtn = document.getElementById('resetBtn');
        const undoBtn = document.getElementById('undoBtn');
        const configBtn = document.getElementById('configBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const playersSection = document.querySelector('.players');
        const rightPanel = document.getElementById('rightControlPanel');
        const authHeaderLink = document.getElementById('authHeaderLink');
        async function resetEntireTournament() {
            if (!isAdmin) return;
            try {
                await groupStageRef.set({ isGroupStageActive: false, groups: {}, matches: {} });
                await playoffRef.set({ isPlayoffActive: false, matches: {} });
            } catch (error) {
                console.error("Error resetting tournament stages:", error);
                alert("‚ö†Ô∏è Failed to reset tournament stages. Check connection.");
            }
        }
        function updateAuthButtons() {
            if (isAuthenticated) {
                authHeaderLink.textContent = 'SIGN OUT';
            } else {
                authHeaderLink.textContent = 'SIGN IN';
            }
        }
        authHeaderLink.onclick = () => {
            if (isAuthenticated) {
                auth.signOut()
                    .then(() => {
                        isAuthenticated = false;
                        isAdmin = false;
                        updateAuthButtons();
                        updateUIPermissions();
                        syncState();
                    })
                    .catch((error) => {
                        console.error("Sign out error:", error);
                        alert("Error signing out.");
                    });
            } else {
                showLoginModal();
            }
        };
        async function checkAdminStatus(user) {
            if (!user || !user.email) return false;
            try {
                const emailKey = user.email.replace('.', ',');
                const snapshot = await adminsRef.child(emailKey).once('value');
                return snapshot.exists();
            } catch (error) {
                console.error("Error checking admin status:", error);
                return false;
            }
        }
        function updateUIPermissions() {
            if (isAdmin && isAuthenticated) {
                undoBtn.style.display = 'flex';
                resetBtn.style.display = 'flex';
                configBtn.style.display = 'flex';
                rightPanel.style.display = 'flex';
            } else {
                undoBtn.style.display = 'none';
                resetBtn.style.display = 'none';
                configBtn.style.display = 'none';
                rightPanel.style.display = 'flex';
            }
        }
        function saveState() {
            if (!isAuthenticated) return;
            const state = {
                activeCaptainIndex,
                teams: teams.map(t => [...t]),
                availablePlayers: [...availablePlayers],
                history: [...history],
                lastUpdatedBy: clientId,
                draftComplete: availablePlayers.length === 0,
                captainsList: [...CAPTAINS],
                teamNamesMap: { ...TEAM_NAMES }
            };
            draftRef.set(state);
            updateUIPermissions();
        }
        function createTeams() {
            teamsContainer.innerHTML = '';
            CAPTAINS.forEach((captain, index) => {
                const div = document.createElement('div');
                div.className = 'team';
                div.id = `team-${index}`;
                const headerDiv = document.createElement('div');
                headerDiv.className = 'team-header';
                headerDiv.id = `team-header-${index}`;
                const captainSpan = document.createElement('span');
                captainSpan.className = 'captain-glow';
                captainSpan.textContent = captain;
                captainSpan.dataset.index = index;
                if (isAdmin && isAuthenticated) {
                    captainSpan.onclick = () => setActiveCaptain(index);
                } else {
                    captainSpan.style.cursor = 'not-allowed';
                    captainSpan.title = "Only admin can select captain manually";
                }
                headerDiv.appendChild(captainSpan);
                div.appendChild(headerDiv);
                const teamNameEl = document.createElement('div');
                teamNameEl.className = 'team-name';
                teamNameEl.id = `team-name-${index}`;
                const currentTeamName = TEAM_NAMES[captain] || "";
                teamNameEl.textContent = currentTeamName;
                div.appendChild(teamNameEl);
                const playersDiv = document.createElement('div');
                playersDiv.className = 'team-players';
                playersDiv.id = `team-players-${index}`;
                div.appendChild(playersDiv);
                teamsContainer.appendChild(div);
            });
        }
        function finalizeDraft() {
            if (playersSection) playersSection.style.display = 'none';
            turnIndicator.innerHTML = '‚úÖ THE DRAW IS COMPLETE!';
            turnIndicator.style.border = '2px solid #44cc44';
            turnIndicator.style.background = 'rgba(20, 30, 20, 0.8)';
            turnIndicator.style.color = '#aaffaa';
            turnIndicator.style.fontSize = '1.4em';
            turnIndicator.style.padding = '16px';
            turnIndicator.style.letterSpacing = '1.5px';
            turnIndicator.style.fontWeight = 'bold';
            turnIndicator.style.textAlign = 'center';
            document.querySelectorAll('.captain-glow').forEach(el => {
                el.style.display = 'none';
            });
            teams.forEach((team, index) => {
                const captainName = CAPTAINS[index];
                const displayList = [captainName, ...team];
                const playersDiv = document.getElementById(`team-players-${index}`);
                if (playersDiv) {
                    playersDiv.innerHTML = displayList.map((p, idx) => {
                        const isCaptain = idx === 0;
                        return `<div class="player selected ${isCaptain ? 'final-captain' : ''}">${p}</div>`;
                    }).join('');
                }
                const teamNameEl = document.getElementById(`team-name-${index}`);
                if (teamNameEl) {
                    teamNameEl.textContent = TEAM_NAMES[captainName] || "";
                    teamNameEl.classList.remove('show');
                    void teamNameEl.offsetWidth;
                    setTimeout(() => {
                        teamNameEl.classList.add('show');
                    }, 100 + index * 150);
                }
            });
            availableEl.innerHTML = '';
            updateUIPermissions();
        }
        function render() {
            if (draftComplete || PLAYERS_LIST.length === 0) {
                finalizeDraft();
                return;
            }
            availableEl.innerHTML = '';
            [...availablePlayers]
                .sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }))
                .forEach(player => {
                    const div = document.createElement('div');
                    div.className = 'player';
                    div.textContent = player;
                    if (isAdmin && isAuthenticated) {
                        div.onclick = () => pickPlayerForActiveCaptain(player);
                    } else {
                        div.style.cursor = 'not-allowed';
                        div.title = "Login as admin to pick players";
                    }
                    availableEl.appendChild(div);
                });
            teams.forEach((team, index) => {
                const playersDiv = document.getElementById(`team-players-${index}`);
                if (playersDiv) {
                    playersDiv.innerHTML = team.map(p => `<div class="player selected">${p}</div>`).join('');
                }
            });
            turnIndicator.innerHTML = 'Captain: <span class="captain-glow" id="currentCaptainIndicator">Choose a captain!</span>';
            turnIndicator.style.border = '2px solid rgba(255,0,51,0.5)';
            turnIndicator.style.background = 'rgba(30,20,30,0.7)';
            turnIndicator.style.color = '#fff';
            turnIndicator.style.fontSize = '1.3em';
            turnIndicator.style.padding = '14px';
            turnIndicator.style.letterSpacing = '1.2px';
            turnIndicator.style.fontWeight = '400';
            turnIndicator.style.textAlign = 'center';
            const newIndicator = document.getElementById('currentCaptainIndicator');
            newIndicator.style.cursor = 'not-allowed';
            newIndicator.title = "Login as admin to select captain";
            if (isAdmin && isAuthenticated) {
                newIndicator.style.cursor = 'pointer';
                newIndicator.onclick = () => {};
            }
            if (activeCaptainIndex !== null) {
                newIndicator.textContent = CAPTAINS[activeCaptainIndex];
                newIndicator.classList.add('active');
                const activeCaptainEl = document.querySelector(`.captain-glow[data-index="${activeCaptainIndex}"]`);
                if (activeCaptainEl) {
                    activeCaptainEl.classList.add('active');
                }
            }
            document.querySelectorAll('.captain-glow').forEach(el => {
                if (el.dataset.index != activeCaptainIndex) {
                    el.classList.remove('active');
                }
            });
            if (playersSection) playersSection.style.display = 'block';
            updateUIPermissions();
        }
        function setActiveCaptain(index) {
            if (draftComplete || !isAdmin) return;
            activeCaptainIndex = index;
            saveState();
            render();
        }
        function pickPlayerForActiveCaptain(player) {
            if (draftComplete || !availablePlayers.includes(player) || activeCaptainIndex === null || !isAuthenticated) {
                if (!isAuthenticated) {
                    showLoginModal();
                    return;
                }
                if (activeCaptainIndex === null) {
                    alert("Please choose a captain first!");
                    return;
                }
                if (teams[activeCaptainIndex].length >= 4) {
                    alert("This captain already has 4 players!");
                    return;
                }
                return;
            }
            teams[activeCaptainIndex] = [...teams[activeCaptainIndex], player];
            availablePlayers = availablePlayers.filter(p => p !== player);
            history = [...history, { captainIndex: activeCaptainIndex, player }];
            saveState();
            if (availablePlayers.length === 0) {
                setTimeout(() => {
                    syncState();
                }, 100);
            } else {
                render();
            }
        }
        function undoLastPick() {
            if (!isAdmin || history.length === 0) return;
            const lastAction = history[history.length - 1];
            const { captainIndex, player } = lastAction;
            teams[captainIndex] = teams[captainIndex].filter(p => p !== player);
            availablePlayers = [...availablePlayers, player];
            history = history.slice(0, -1);
            draftComplete = false;
            saveState();
            render();
        }
        async function resetDraft() {
            if (!isAdmin) return;
            if (confirm("Are you sure you want to reset the draft AND tournament stages?")) {
                teams = Array(CAPTAINS.length).fill().map(() => []);
                availablePlayers = [...PLAYERS_LIST];
                activeCaptainIndex = null;
                history = [];
                draftComplete = false;
                saveState();
                createTeams();
                render();
                await resetEntireTournament();
                alert("‚úÖ Draft and tournament stages have been reset.");
            }
        }
        resetBtn.onclick = () => resetDraft();
        undoBtn.onclick = () => {
            if (!isAdmin) {
                alert("Only admin can undo picks.");
                return;
            }
            if (history.length > 0) {
                undoLastPick();
            } else {
                alert("No actions to undo!");
            }
        };
        async function loadConfig() {
            try {
                const snapshot = await configRef.once('value');
                const config = snapshot.val();
                if (config) {
                    if (Array.isArray(config.captains) && config.captains.length >= 2) {
                        CAPTAINS = [...config.captains];
                    }
                    if (typeof config.teams === 'object') {
                        TEAM_NAMES = { ...config.teams };
                    }
                    if (Array.isArray(config.players) && config.players.length > 0) {
                        PLAYERS_LIST = [...config.players];
                    }
                } else {
                    await createDefaultConfig();
                }
                initializeDraft();
            } catch (error) {
                console.error("Error loading config:", error);
                await createDefaultConfig();
                initializeDraft();
            }
        }
        async function createDefaultConfig() {
            const defaultConfig = {
                captains: [
                    "And", "Imob", "ARRRRRRRRR", "Maximzor",
                    "Mishche", "TechN", "blanj", "MrFuckYou"
                ].sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' })),
                teams: {
                    "MrFuckYou": "Mighty44",
                    "Mishche": "FUN",
                    "ARRRRRRRRR": "wassup",
                    "Imob": "HOROSHO",
                    "blanj": "Azonic",
                    "Maximzor": "sdvegeshniki1337",
                    "And": "5—Å–∞–±–∞–∫",
                    "TechN": "Frag by"
                },
                players: [
                    "GRAPPLER", "Nitro", "drz", "javac", "hondroz", "alpine", "spiker", "semiq",
                    "ololo", "PASHAKENTAVR", "trixen", "Kirsten", "trip", "bones", "Sairus", "DoG2h",
                    "rus1an4eg", "Kolenzored", "Tragvar", "Whiskas", "shaggy", "resident", "Dimboss", "M3dgiK",
                    "Neale", "GNoMJKe", "HORSEEE", "Jonni", "kroshka_freya", "pushpushpush", "rrrrr",
                    "Dect"
                ]
            };
            const snapshot = await configRef.once('value');
            if (!snapshot.exists()) {
                await configRef.set(defaultConfig);
            }
            CAPTAINS = [...defaultConfig.captains];
            TEAM_NAMES = { ...defaultConfig.teams };
            PLAYERS_LIST = [...defaultConfig.players];
        }
        function initializeDraft() {
            teams = Array(CAPTAINS.length).fill().map(() => []);
            availablePlayers = [...PLAYERS_LIST];
            activeCaptainIndex = null;
            history = [];
            draftComplete = false;
            createTeams();
            loadingIndicator.style.display = 'none';
            render();
            draftRef.on('value', (snapshot) => {
                const saved = snapshot.val();
                if (saved && saved.lastUpdatedBy !== clientId) {
                    syncState();
                }
            });
            draftRef.on('error', (error) => {
                console.error("Firebase error:", error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'firebase-error';
                errorDiv.textContent = '‚ö†Ô∏è Connection to draft server failed.';
                teamsContainer.innerHTML = '';
                teamsContainer.appendChild(errorDiv);
            });
            setTimeout(() => {
                if (loadingIndicator.style.display !== 'none') {
                    loadingIndicator.style.display = 'none';
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'firebase-error';
                    errorDiv.textContent = '‚ö†Ô∏è Could not load draft state. Check your connection.';
                    teamsContainer.prepend(errorDiv);
                }
            }, 5000);
        }
        function syncState() {
            draftRef.once('value', (snapshot) => {
                const saved = snapshot.val();
                if (saved) {
                    if (saved.captainsList && Array.isArray(saved.captainsList) && saved.captainsList.length >= 2) {
                        CAPTAINS = [...saved.captainsList];
                    }
                    if (saved.teamNamesMap && typeof saved.teamNamesMap === 'object') {
                        TEAM_NAMES = { ...saved.teamNamesMap };
                    }
                    let loadedTeams = saved.teams || [];
                    if (!Array.isArray(loadedTeams)) loadedTeams = [];
                    teams = Array(CAPTAINS.length).fill().map((_, i) => {
                        return Array.isArray(loadedTeams[i]) ? [...loadedTeams[i]] : [];
                    });
                    availablePlayers = saved.availablePlayers || [...PLAYERS_LIST];
                    history = saved.history || [];
                    draftComplete = saved.draftComplete || (availablePlayers.length === 0);
                    const isDraftNotStarted = availablePlayers.length === PLAYERS_LIST.length;
                    activeCaptainIndex = isDraftNotStarted ? null : saved.activeCaptainIndex;
                } else {
                    teams = Array(CAPTAINS.length).fill().map(() => []);
                    availablePlayers = [...PLAYERS_LIST];
                    activeCaptainIndex = null;
                    history = [];
                    draftComplete = false;
                }
                createTeams();
                if (draftComplete) {
                    finalizeDraft();
                } else {
                    render();
                }
                loadingIndicator.style.display = 'none';
                updateUIPermissions();
            });
        }
        function showLoginModal() {
            if (document.getElementById('authModal')) return;
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.id = 'authModal';
            overlay.innerHTML = `
                <div class="modal-content">
                    <h3>üîê Login</h3>
                    <input type="email" class="modal-input" id="emailInput" placeholder="Email" autocomplete="email">
                    <input type="password" class="modal-input" id="passwordInput" placeholder="Password" autocomplete="current-password">
                    <div class="modal-error" id="authError"></div>
                    <button class="modal-btn" id="submitLogin">Login</button>
                    <div class="modal-footer">
                        Contact admin for access.
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            const submitBtn = overlay.querySelector('#submitLogin');
            const emailInput = overlay.querySelector('#emailInput');
            const passwordInput = overlay.querySelector('#passwordInput');
            const errorEl = overlay.querySelector('#authError');
            submitBtn.onclick = () => {
                const email = emailInput.value.trim();
                const password = passwordInput.value;
                if (!email || !password) {
                    errorEl.textContent = "Please fill in all fields.";
                    return;
                }
                auth.signInWithEmailAndPassword(email, password)
                    .then(async (userCredential) => {
                        isAuthenticated = true;
                        isAdmin = await checkAdminStatus(userCredential.user);
                        document.body.removeChild(overlay);
                        updateAuthButtons();
                        updateUIPermissions();
                        syncState();
                    })
                    .catch((error) => {
                        console.error("Auth error:", error);
                        errorEl.textContent = "Invalid email or password.";
                    });
            };
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            };
        }
        configBtn.onclick = () => {
            if (!isAdmin) {
                alert("Only the administrator can change the configuration.");
                return;
            }
            showConfigModal();
        };
        function showConfigModal() {
            const modal = document.getElementById('configModal');
            if (!modal) {
                createConfigModal();
            }
            document.getElementById('configModal').style.display = 'flex';
            document.getElementById('configCaptains').value = CAPTAINS.join('\n');
            document.getElementById('configTeams').value = CAPTAINS.map(captain => TEAM_NAMES[captain] || "").join('\n');
            document.getElementById('configPlayers').value = PLAYERS_LIST.join('\n');
            document.querySelectorAll('.tab-btn-config').forEach(btn => {
                btn.onclick = function() {
                    document.querySelectorAll('.tab-btn-config').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.config-tab-config').forEach(tab => tab.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('tab-' + this.dataset.tab).classList.add('active');
                };
            });
            document.getElementById('cancelConfigBtn').onclick = () => {
                document.getElementById('configModal').style.display = 'none';
            };
            document.getElementById('saveConfigBtn').onclick = async () => {
                const errorEl = document.getElementById('configError');
                errorEl.textContent = '';
                try {
                    const newCaptains = document.getElementById('configCaptains').value
                        .split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0);
                    const newTeamNamesLines = document.getElementById('configTeams').value
                        .split('\n')
                        .map(line => line.trim());
                    const newPlayers = document.getElementById('configPlayers').value
                        .split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0);
                    if (newCaptains.length < 2) {
                        errorEl.textContent = "There must be at least 2 captains.";
                        return;
                    }
                    const newTeamNames = {};
                    newCaptains.forEach((captain, index) => {
                        const teamName = newTeamNamesLines[index] || "";
                        if (teamName) {
                            newTeamNames[captain] = teamName;
                        }
                    });
                    const newConfig = {
                        captains: newCaptains,
                        teams: newTeamNames,
                        players: newPlayers
                    };
                    await configRef.set(newConfig);
                    CAPTAINS = [...newCaptains];
                    TEAM_NAMES = { ...newTeamNames };
                    PLAYERS_LIST = [...newPlayers];
                    teams = Array(CAPTAINS.length).fill().map(() => []);
                    availablePlayers = [...PLAYERS_LIST];
                    activeCaptainIndex = null;
                    history = [];
                    draftComplete = false;
                    if (PLAYERS_LIST.length === 0) {
                        draftComplete = true;
                    }
                    saveState();
                    createTeams();
                    render();
                    updateUIPermissions();
                    await resetEntireTournament();
                    document.getElementById('configModal').style.display = 'none';
                    alert("‚úÖ The configuration is successfully preserved and applied!");
                } catch (error) {
                    console.error("Error saving config:", error);
                    errorEl.textContent = "Error saving configuration. Check the data and connection.";
                }
            };
        }
        function createConfigModal() {
            const modalHTML = `
                <div class="modal-overlay-config" id="configModal">
                    <div class="modal-content-config">
                        <div style="position:absolute; top:16px; right:16px; font-size:1.8em; cursor:pointer; color:#ff6666; z-index:10;" onclick="document.getElementById('configModal').style.display='none'">√ó</div>
                        <h3>‚öôÔ∏è NAMES SETTINGS</h3>
                        <div class="modal-tabs">
                            <button class="tab-btn-config active" data-tab="captains">CAPTAINS</button>
                            <button class="tab-btn-config" data-tab="teams">TEAMS</button>
                            <button class="tab-btn-config" data-tab="players">PLAYERS</button>
                        </div>
                        <div class="config-tab-config active" id="tab-captains">
                            <label class="modal-label">Enter captain names (one per line):</label>
                            <textarea id="configCaptains" class="modal-textarea-config" rows="8" placeholder="And\nImob\n..."></textarea>
                        </div>
                        <div class="config-tab-config" id="tab-teams">
                            <label class="modal-label">Team names (in captain order):</label>
                            <textarea id="configTeams" class="modal-textarea-config" rows="8" placeholder="5—Å–∞–±–∞–∫\nHOROSHO\n..."></textarea>
                        </div>
                        <div class="config-tab-config" id="tab-players">
                            <label class="modal-label">List of players (one per line):</label>
                            <textarea id="configPlayers" class="modal-textarea-config" rows="15" placeholder="GRAPPLER\nNitro\n..."></textarea>
                        </div>
                        <div class="modal-error-config" id="configError"></div>
                        <div class="modal-buttons">
                            <button class="modal-btn-config save-btn" id="saveConfigBtn">üíæ SAVE</button>
                            <button class="modal-btn-config cancel-btn" id="cancelConfigBtn">‚úñÔ∏è CANCEL</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        auth.onAuthStateChanged(async (user) => {
            isAuthenticated = !!user;
            if (user) {
                isAdmin = await checkAdminStatus(user);
            } else {
                isAdmin = false;
            }
            updateAuthButtons();
            updateUIPermissions();
            syncState();
        });
        loadConfig();
    </script>
</body>
</html>