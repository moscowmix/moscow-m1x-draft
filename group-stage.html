<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Group Stage</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <link rel="icon" href="/favicon.ico">
    <link rel="icon" type="image/png" href="/moscow-m1x-draft/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/moscow-m1x-draft/favicon.svg" />
    <link rel="shortcut icon" href="/moscow-m1x-draft/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/moscow-m1x-draft/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Moscow-m1x-draft" />
    <link rel="manifest" href="/moscow-m1x-draft/site.webmanifest" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 19px;
            letter-spacing: 1.2px;
            background: url('bg2.png') center center / cover fixed;
            color: #e0e0e0;
            line-height: 1.6;
            padding: 16px 12px;
        }
        .back-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            width: 48px;
            height: 48px;
            background: rgba(30, 40, 60, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #66ccff;
            font-size: 20px;
            cursor: pointer;
            z-index: 1000;
            border: 1px solid rgba(100, 200, 255, 0.4);
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            transition: all 0.25s;
        }
        .back-btn:hover {
            background: rgba(40, 50, 70, 0.9);
            transform: translateY(-2px);
        }
        .groups-header {
            text-align: center;
            margin: 20px 0 30px;
            color: #66ffcc;
            font-size: 2.4em;
            text-shadow: 0 0 8px rgba(102, 255, 204, 0.6);
            letter-spacing: 2px;
            padding-top: 20px;
        }
        .loading, .firebase-error {
            text-align: center;
            padding: 30px;
            font-size: 1.2em;
            margin: 20px auto;
            max-width: 600px;
        }
        .loading {
            color: #ffcc00;
        }
        .firebase-error {
            background: rgba(80, 20, 20, 0.9);
            color: #ff6666;
            border-radius: 10px;
            border: 1px solid #ff3333;
        }

        .groups-container {
            display: flex;
            gap: 100px;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: nowrap;
            max-width: 1100px;
            margin: 0 auto;
        }

        .group-box {
            flex: 1;
            min-width: 800px;
            max-width: 800px;
            background: rgba(20, 20, 40, 0.8);
            border-radius: 16px;
            padding: 24px;
            border: 2px solid rgba(100, 255, 200, 0.3);
            margin-right: 20px;
            box-sizing: border-box;
        }

        .group-box:last-child {
            margin-right: 0;
        }

        @media (max-width: 950px) {
            .groups-container {
                flex-direction: column;
                align-items: center;
            }
            .group-box {
                margin-right: 0;
                margin-bottom: 20px;
                width: 100%;
                max-width: 100%;
                min-width: 320px;
                overflow: hidden;
            }
        }

        .group-title {
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 16px;
            color: #66ffcc;
            letter-spacing: 1.5px;
        }

        
        .standings-table-wrapper {
            overflow-x: auto;
            margin-top: 16px;
            width: 100%;
        }

        .matches-table, .standings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.98em;
        }

        .matches-table th,
        .matches-table td,
        .standings-table th,
        .standings-table td {
            padding: 10px 12px;
            text-align: center;
            border: 1px solid rgba(100, 200, 255, 0.3);
            white-space: nowrap;
        }

        .matches-table th,
        .standings-table th {
            background: rgba(0, 100, 80, 0.6);
            color: #66ffcc;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .standings-table .rank-first {
            background: rgba(50, 200, 100, 0.25);
            border-left: 3px solid #44ff88;
        }
        .standings-table .rank-second {
            background: rgba(100, 180, 255, 0.25);
            border-left: 3px solid #66ccff;
        }
        .standings-table .rank-first td:first-child,
        .standings-table .rank-second td:first-child {
            font-weight: bold;
        }

        
        @media (max-width: 600px) {
            .standings-table th,
            .standings-table td {
                padding: 6px 8px;
                font-size: 0.85em;
                min-width: 40px;
            }
            .standings-table th:nth-child(1),
            .standings-table td:nth-child(1) {
                min-width: 80px;
            }
            .standings-table th:nth-child(6),
            .standings-table td:nth-child(6),
            .standings-table th:nth-child(7),
            .standings-table td:nth-child(7) {
                min-width: 50px;
            }
        }

        @media (max-width: 375px) {
            .standings-table th,
            .standings-table td {
                padding: 5px 6px;
                font-size: 0.8em;
            }
        }

        
        .match-cell {
            cursor: pointer;
            transition: background 0.2s;
            min-width: 150px;
            padding: 8px 10px;
            font-size: 1.05em;
        }

        .match-cell:hover {
            background: rgba(100, 200, 255, 0.1);
        }

        .match-cell.completed {
            background: rgba(0, 150, 120, 0.3);
        }

        .map-select {
            background: rgba(30, 30, 50, 0.8);
            color: white;
            border: 1px solid rgba(100, 200, 255, 0.4);
            border-radius: 6px;
            padding: 6px 10px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1em;
            min-width: 100px;
            width: 100%;
        }

        .score-input {
            width: 55px;
            background: rgba(30, 30, 50, 0.8);
            color: white;
            border: 1px solid rgba(100, 200, 255, 0.4);
            border-radius: 6px;
            text-align: center;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1em;
            padding: 6px;
            min-width: 55px;
            flex-shrink: 0;
        }

        .score-separator {
            font-weight: bold;
            color: #e0e0e0;
            padding: 0 6px;
            font-size: 1.1em;
            flex-shrink: 0;
        }

        
        .match-card {
            background: rgba(30, 30, 50, 0.7);
            border: 1px solid rgba(100, 200, 255, 0.3);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .match-card.round-header {
            background: rgba(0, 100, 80, 0.6);
            color: #66ffcc;
            text-align: center;
            font-size: 1.2em;
            margin-top: 16px;
            border: none;
            border-radius: 8px;
        }

        .match-card-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .match-teams {
            font-size: 1.1em;
            text-align: center;
            padding: 6px 0;
            font-weight: bold;
        }

        .match-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        .match-control-group {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            min-width: 120px;
        }

        @media (max-width: 768px) {
            .matches-table th:nth-child(2),
            .matches-table td:nth-child(2) {
                min-width: 120px;
                font-size: 0.9em;
            }

            .matches-table th:nth-child(3),
            .matches-table td:nth-child(3) {
                min-width: 80px;
            }

            .matches-table th:nth-child(4),
            .matches-table td:nth-child(4) {
                min-width: 130px;
            }

            .score-input {
                width: 40px;
                padding: 4px;
                font-size: 0.85em;
            }

            .map-select {
                min-width: 80px;
                font-size: 0.85em;
                padding: 4px 6px;
            }

            .score-separator {
                padding: 0 3px;
                font-size: 1em;
            }
        }

        @media (max-width: 600px) {
            .matches-table-wrapper {
                display: none;
            }
            .matches-cards-wrapper {
                display: block;
            }
            .group-title {
                font-size: 1.6em;
            }
            .match-control-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            .map-select, .score-input {
                width: 100%;
                font-size: 1em;
            }
        }

        @media (min-width: 601px) {
            .matches-cards-wrapper {
                display: none;
            }
        }

        .footer-credit {
            text-align: center;
            margin-top: 70px;
            padding: 10px 0;
            font-size: 0.85em;
            color: #777;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn" title="–ù–∞–∑–∞–¥ –∫ –¥—Ä–∞—Ñ—Ç—É">‚Üê</a>
    <h1 class="groups-header">GROUP STAGE</h1>
    <div id="groupsContent">
        <div class="loading">Loading group stage data...</div>
    </div>

    <div class="footer-credit">
        Developed by Snip & Qwen | Powered by Firebase üåê
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBWnLO_5YgaNFiy-wvynVEKcMnS8V55FXY",
            authDomain: "moscow-m1x-draft-f9da4.firebaseapp.com",
            databaseURL: "https://moscow-m1x-draft-f9da4-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "moscow-m1x-draft-f9da4",
            storageBucket: "moscow-m1x-draft-f9da4.firebasestorage.app",
            messagingSenderId: "391636730262",
            appId: "1:391636730262:web:2441abb086b5336b451db7"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const groupStageRef = database.ref('moscowM1X/groupStage');

        let isAuthenticated = false;
        let isAdmin = false;

        const groupsContent = document.getElementById('groupsContent');

        function getFixedMatchesForGroup(groupName) {
            const matches = [];

            if (groupName === 'A') {
                matches.push({ round: 1, team1: 'Azonic', team2: 'sdvegeshniki1337' });
                matches.push({ round: 1, team1: 'Mighty44', team2: 'INTO' });
                matches.push({ round: 2, team1: 'INTO', team2: 'Azonic' });
                matches.push({ round: 2, team1: 'sdvegeshniki1337', team2: 'Mighty44' });
                matches.push({ round: 3, team1: 'Mighty44', team2: 'Azonic' });
                matches.push({ round: 3, team1: 'sdvegeshniki1337', team2: 'INTO' });
            } else if (groupName === 'B') {
                matches.push({ round: 1, team1: 'Frag by', team2: 'HOROSHO' });
                matches.push({ round: 1, team1: '5KOWE4EK', team2: 'wazzup' });
                matches.push({ round: 2, team1: 'wazzup', team2: 'Frag by' });
                matches.push({ round: 2, team1: 'HOROSHO', team2: '5KOWE4EK' });
                matches.push({ round: 3, team1: '5KOWE4EK', team2: 'Frag by' });
                matches.push({ round: 3, team1: 'HOROSHO', team2: 'wazzup' });
            }

            return matches.map((m, idx) => ({
                ...m,
                group: groupName,
                key: `${groupName}_${m.round}_${idx % 2 + 1}`,
                map: null,
                score1: null,
                score2: null,
                completed: false
            }));
        }

        function calculateStandings(groupName, teams, allMatches) {
            const stats = {};
            teams.forEach(team => {
                stats[team] = {
                    team,
                    wins: 0,
                    draws: 0,
                    losses: 0,
                    points: 0,
                    played: 0,
                    roundsWon: 0,
                    roundsLost: 0
                };
            });

            Object.values(allMatches).forEach(match => {
                if (match.group !== groupName || !match.completed) return;
                const { team1, team2, score1, score2 } = match;

                stats[team1].played++;
                stats[team2].played++;

                stats[team1].roundsWon += score1;
                stats[team1].roundsLost += score2;
                stats[team2].roundsWon += score2;
                stats[team2].roundsLost += score1;

                if (score1 > score2) {
                    stats[team1].wins++;
                    stats[team1].points += 3;
                    stats[team2].losses++;
                } else if (score1 < score2) {
                    stats[team2].wins++;
                    stats[team2].points += 3;
                    stats[team1].losses++;
                } else {
                    stats[team1].draws++;
                    stats[team2].draws++;
                    stats[team1].points += 1;
                    stats[team2].points += 1;
                }
            });

            Object.values(stats).forEach(stat => {
                stat.roundDiff = stat.roundsWon - stat.roundsLost;
            });

            return Object.values(stats).sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.wins !== a.wins) return b.wins - a.wins;
                if (b.roundDiff !== a.roundDiff) return b.roundDiff - a.roundDiff;
                return 0;
            });
        }

        let groupStageData = {
            isGroupStageActive: true,
            groups: {
                A: ['Azonic', 'sdvegeshniki1337', 'Mighty44', 'INTO'],
                B: ['Frag by', 'HOROSHO', '5KOWE4EK', 'wazzup']
            },
            matches: {}
        };

        ['A', 'B'].forEach(g => {
            const matches = getFixedMatchesForGroup(g);
            matches.forEach(m => {
                groupStageData.matches[m.key] = { ...m };
            });
        });

        function saveGroupStage() {
            if (!isAuthenticated || !isAdmin) return;
            groupStageRef.set(groupStageData);
        }

        function checkMatchCompletion(key) {
            const match = groupStageData.matches[key];
            const s1 = match.score1;
            const s2 = match.score2;
            const map = match.map;

            if (s1 === null || s2 === null || map === null || map === '') {
                match.completed = false;
                return;
            }

            const isWin = (
                (s1 === 16 && s2 >= 0 && s2 <= 14) ||
                (s2 === 16 && s1 >= 0 && s1 <= 14)
            );
            const isDraw = (s1 === 15 && s2 === 15);

            match.completed = isWin || isDraw;
        }

        function renderMatchCard(groupName, match) {
            const card = document.createElement('div');
            card.className = 'match-card';
            if (match.completed) card.style.opacity = '0.9';

            const teamsDiv = document.createElement('div');
            teamsDiv.className = 'match-teams';
            teamsDiv.textContent = `${match.team1} vs ${match.team2}`;

            const mapSelect = document.createElement('select');
            mapSelect.className = 'map-select';
            const emptyOpt = document.createElement('option');
            emptyOpt.value = '';
            emptyOpt.textContent = '‚Äî';
            emptyOpt.selected = match.map === null;
            mapSelect.appendChild(emptyOpt);
            const maps = ['de_dust2', 'de_inferno', 'de_nuke', 'de_tuscan', 'de_train'];
            maps.forEach(map => {
                const opt = document.createElement('option');
                opt.value = map;
                opt.textContent = map;
                if (match.map === map) opt.selected = true;
                mapSelect.appendChild(opt);
            });

            if (!isAdmin || !isAuthenticated) {
                mapSelect.disabled = true;
            } else {
                mapSelect.onchange = () => {
                    groupStageData.matches[match.key].map = mapSelect.value || null;
                    checkMatchCompletion(match.key);
                    saveGroupStage();
                };
            }

            const score1Input = document.createElement('input');
            score1Input.type = 'number';
            score1Input.className = 'score-input';
            score1Input.value = match.score1 !== null ? match.score1 : '';
            score1Input.min = 0;
            score1Input.max = 16;
            if (!isAdmin || !isAuthenticated) {
                score1Input.disabled = true;
            } else {
                score1Input.oninput = () => {
                    let val = parseInt(score1Input.value);
                    if (isNaN(val) || val < 0) return;
                    if (val > 16) score1Input.value = 16;
                };
                score1Input.onchange = () => {
                    const v = score1Input.value.trim();
                    groupStageData.matches[match.key].score1 = v === '' ? null : parseInt(v);
                    checkMatchCompletion(match.key);
                    saveGroupStage();
                };
            }

            const separator = document.createElement('span');
            separator.className = 'score-separator';
            separator.textContent = ':';

            const score2Input = document.createElement('input');
            score2Input.type = 'number';
            score2Input.className = 'score-input';
            score2Input.value = match.score2 !== null ? match.score2 : '';
            score2Input.min = 0;
            score2Input.max = 16;
            if (!isAdmin || !isAuthenticated) {
                score2Input.disabled = true;
            } else {
                score2Input.oninput = () => {
                    let val = parseInt(score2Input.value);
                    if (isNaN(val) || val < 0) return;
                    if (val > 16) score2Input.value = 16;
                };
                score2Input.onchange = () => {
                    const v = score2Input.value.trim();
                    groupStageData.matches[match.key].score2 = v === '' ? null : parseInt(v);
                    checkMatchCompletion(match.key);
                    saveGroupStage();
                };
            }

            const scoreGroup = document.createElement('div');
            scoreGroup.className = 'match-control-group';
            scoreGroup.appendChild(score1Input);
            scoreGroup.appendChild(separator);
            scoreGroup.appendChild(score2Input);

            const mapGroup = document.createElement('div');
            mapGroup.className = 'match-control-group';
            const mapLabel = document.createElement('div');
            mapLabel.style.fontSize = '0.9em';
            mapLabel.textContent = 'Map:';
            mapGroup.appendChild(mapLabel);
            mapGroup.appendChild(mapSelect);

            const controls = document.createElement('div');
            controls.className = 'match-controls';
            controls.appendChild(mapGroup);
            controls.appendChild(scoreGroup);

            const content = document.createElement('div');
            content.className = 'match-card-content';
            content.appendChild(teamsDiv);
            content.appendChild(controls);

            card.appendChild(content);
            return card;
        }

        function renderGroupStagePage() {
            groupsContent.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'groups-container';

            ['A', 'B'].forEach(groupName => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'group-box';
                const title = document.createElement('div');
                title.className = 'group-title';
                title.textContent = `GROUP ${groupName}`;
                groupDiv.appendChild(title);

                const standings = calculateStandings(
                    groupName,
                    groupStageData.groups[groupName],
                    groupStageData.matches
                );

                const standingsTable = document.createElement('table');
                standingsTable.className = 'standings-table';
                standingsTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>TEAM</th>
                            <th>M</th>
                            <th>W</th>
                            <th>D</th>
                            <th>L</th>
                            <th>+/-</th>
                            <th>PTS</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${standings.map((s, idx) => {
                            const rankClass = idx === 0 ? 'rank-first' : (idx === 1 ? 'rank-second' : '');
                            return `
                                <tr class="${rankClass}">
                                    <td>${s.team}</td>
                                    <td>${s.played}</td>
                                    <td>${s.wins}</td>
                                    <td>${s.draws}</td>
                                    <td>${s.losses}</td>
                                    <td>${s.roundDiff}</td>
                                    <td>${s.points}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                `;

                const standingsWrapper = document.createElement('div');
                standingsWrapper.className = 'standings-table-wrapper';
                standingsWrapper.appendChild(standingsTable);
                groupDiv.appendChild(standingsWrapper);

                const matchesTable = document.createElement('table');
                matchesTable.className = 'matches-table';
                matchesTable.innerHTML = '<thead><tr><th>ROUND</th><th>MATCH</th><th>MAP</th><th>SCORE</th></tr></thead><tbody></tbody>';
                const tbody = matchesTable.querySelector('tbody');
                for (let round = 1; round <= 3; round++) {
                    const roundMatches = Object.values(groupStageData.matches)
                        .filter(m => m.group === groupName && m.round === round);
                    roundMatches.forEach((match, idx) => {
                        const row = document.createElement('tr');

                        const matchCell = document.createElement('td');
                        matchCell.className = 'match-cell';
                        matchCell.textContent = `${match.team1} vs ${match.team2}`;
                        if (match.completed) matchCell.classList.add('completed');

                        const mapCell = document.createElement('td');
                        const mapSelect = document.createElement('select');
                        mapSelect.className = 'map-select';
                        const emptyOpt = document.createElement('option');
                        emptyOpt.value = '';
                        emptyOpt.textContent = '‚Äî';
                        emptyOpt.selected = match.map === null;
                        mapSelect.appendChild(emptyOpt);
                        const maps = ['de_dust2', 'de_inferno', 'de_nuke', 'de_tuscan', 'de_train'];
                        maps.forEach(map => {
                            const opt = document.createElement('option');
                            opt.value = map;
                            opt.textContent = map;
                            if (match.map === map) opt.selected = true;
                            mapSelect.appendChild(opt);
                        });

                        if (!isAdmin || !isAuthenticated) {
                            mapSelect.disabled = true;
                        } else {
                            mapSelect.onchange = () => {
                                groupStageData.matches[match.key].map = mapSelect.value || null;
                                checkMatchCompletion(match.key);
                                saveGroupStage();
                            };
                        }
                        mapCell.appendChild(mapSelect);

                        const scoreCell = document.createElement('td');
                        scoreCell.style.display = 'flex';
                        scoreCell.style.alignItems = 'center';
                        scoreCell.style.justifyContent = 'center';
                        scoreCell.style.gap = '4px';
                        scoreCell.style.width = '100%';

                        const score1Input = document.createElement('input');
                        score1Input.type = 'number';
                        score1Input.className = 'score-input';
                        score1Input.value = match.score1 !== null ? match.score1 : '';
                        score1Input.min = 0;
                        score1Input.max = 16;
                        if (!isAdmin || !isAuthenticated) {
                            score1Input.disabled = true;
                        } else {
                            score1Input.oninput = () => {
                                let val = parseInt(score1Input.value);
                                if (isNaN(val) || val < 0) return;
                                if (val > 16) score1Input.value = 16;
                            };
                            score1Input.onchange = () => {
                                const v = score1Input.value.trim();
                                groupStageData.matches[match.key].score1 = v === '' ? null : parseInt(v);
                                checkMatchCompletion(match.key);
                                saveGroupStage();
                            };
                        }

                        const separator = document.createElement('span');
                        separator.className = 'score-separator';
                        separator.textContent = ':';

                        const score2Input = document.createElement('input');
                        score2Input.type = 'number';
                        score2Input.className = 'score-input';
                        score2Input.value = match.score2 !== null ? match.score2 : '';
                        score2Input.min = 0;
                        score2Input.max = 16;
                        if (!isAdmin || !isAuthenticated) {
                            score2Input.disabled = true;
                        } else {
                            score2Input.oninput = () => {
                                let val = parseInt(score2Input.value);
                                if (isNaN(val) || val < 0) return;
                                if (val > 16) score2Input.value = 16;
                            };
                            score2Input.onchange = () => {
                                const v = score2Input.value.trim();
                                groupStageData.matches[match.key].score2 = v === '' ? null : parseInt(v);
                                checkMatchCompletion(match.key);
                                saveGroupStage();
                            };
                        }

                        scoreCell.appendChild(score1Input);
                        scoreCell.appendChild(separator);
                        scoreCell.appendChild(score2Input);

                        row.innerHTML = `<td>ROUND ${round}</td>`;
                        row.appendChild(matchCell);
                        row.appendChild(mapCell);
                        row.appendChild(scoreCell);
                        tbody.appendChild(row);
                    });
                }

                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'matches-table-wrapper';
                tableWrapper.style.overflowX = 'auto';
                tableWrapper.style.marginTop = '16px';
                tableWrapper.appendChild(matchesTable);
                groupDiv.appendChild(tableWrapper);

                const cardsWrapper = document.createElement('div');
                cardsWrapper.className = 'matches-cards-wrapper';
                for (let round = 1; round <= 3; round++) {
                    const roundHeader = document.createElement('div');
                    roundHeader.className = 'match-card round-header';
                    roundHeader.textContent = `ROUND ${round}`;
                    cardsWrapper.appendChild(roundHeader);

                    const roundMatches = Object.values(groupStageData.matches)
                        .filter(m => m.group === groupName && m.round === round);
                    roundMatches.forEach(match => {
                        cardsWrapper.appendChild(renderMatchCard(groupName, match));
                    });
                }
                groupDiv.appendChild(cardsWrapper);

                container.appendChild(groupDiv);
            });

            groupsContent.appendChild(container);
        }

        function loadGroupStage() {
            groupStageRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.matches) {
                    groupStageData.matches = data.matches || {};
                }
                renderGroupStagePage();
            }, (error) => {
                console.error("Firebase error:", error);
                groupsContent.innerHTML = `<div class="firebase-error">Error connecting to group stage data: ${error.message}</div>`;
            });
        }

        async function checkAdminStatus(user) {
            if (!user || !user.email) return false;
            try {
                const emailKey = user.email.replace('.', ',');
                const snapshot = await database.ref('moscowM1X/admins').child(emailKey).once('value');
                return snapshot.exists();
            } catch (error) {
                return false;
            }
        }

        auth.onAuthStateChanged(async (user) => {
            isAuthenticated = !!user;
            isAdmin = user ? await checkAdminStatus(user) : false;
            loadGroupStage();
        });

        renderGroupStagePage();
    </script>
</body>
</html>
